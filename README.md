# Astra WRU
NodeJS app to generate writes to tables based on the schema. With this process, the request write sizes for each table can be checked.

# Motivation

The right write size of the Cassandra workloads is complex to discover. Depending on the case, this lack of this information can cause the estimates to be underestimated.

In cases where it is needed to migrate a big cluster to Astra, doing this analysis consumes a lot of time, and it is hard to be sure of the numbers.

So, in conjunction with the CQL Proxy version that stores the metrics, this app will generate a simulated workload based on schema files to understand the behavior for each table.

# How it works

The first thing is to run CQL Proxy locally. It needed to use the version from [https://github.com/qzg/cql-proxy], which collects the read and write metrics.

The app connected to the local CQL Proxy will read all the schema files from the "schema" folder.

Then, it will create the types and tables for each table.

For each table, the app generates 100 records (this quantity can be changed if needed).

After finishing all tasks, the CQL Proxy stats are collected into a file with the write sizes in the "out" folder.

Tables and Types are dropped from the database.

# How to use it

## Pre requisites

- An Astra Database and Keyspace specifically for this process. (WARNING: Tables and types are created and dropped all the time, so choose an empty database to use)
- Golang (to build the CQL Proxy)
- NodeJS

## Setting environment variables

Rename the file .env_sample file to .env.

Update the variables with the correct information.

## Starting the CQL Proxy

Clone the git repo from https://github.com/qzg/cql-proxy.

Build it following the instructions available in the readme.

Start it with the following parameters:
- --astra-bundle
- --username
- --password
- --track-usage 
- --usage-keyspace app

The file start-cql-proxy.sh can be used to start the CQL Proxy.

## Installing dependencies

In the app root folder, run:

````
npm install

````

## Running the app

- Place the schemas files in the "schemas" folder

- To run the estimates based on the schema files only, run:

````
npm run schema

````

- To run the estimates based on the cql-proxy metrics, run:

````
npm run start

````

- To collect the metrics without processing the schemas, run:

````
npm run metrics

````

## Results

All the results are available at the out folder:

- table_stats_from_cql_proxy.csv : Table stats based on the simulated workload to Astra
- table_stats_from_schema.csv : Table stats based on the schema structure only
- Logs and errors also available

## Results file:

The table_stats.csv file contains the following columns:

- table_ref: keyspace and table names, separated by a dot
- keyspace
- table
- write_count: Quantity of inserts or updates sent to the table
- write_size: Insert size, in bytes, generated by the commands
- write_wrus: WRU consumed by the inserts and updates
- writes_size: Write size, in bytes
- WRU per record: How many WRUs are consumed per one single insert/update
- RRU per "N" rows: RRUs consumed with one SELECT * FROM table LIMIT "N".
- Rows per RRU: How many records fit in one RRU (4kb) . This information can help understand read requests consumption

## Hints

- If it is needed to run the process multiple times, restart the CQL Proxy. 
- Stats tables are truncated at the beginning of the process.
- Multiple schema files can be processed in one execution. Place them all in the schemas folder.
- Parameters can be changed in the consts file and in the beginning of the index file.

# Known issues

- Columns with UDT or advanced data types are not generated
- Understand the impact of SAI in the write size